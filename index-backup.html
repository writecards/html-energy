<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="cloud-sm.png" />
    <link rel="stylesheet" href="style-backup.css" />
    <title>HTML Day 2025 Shanghai</title>
  </head>
  <body>
    <div class="big-parent">
      <div class="left-side">
        <h3>HTML Day 2025 Shanghai</h3>
        <div class="question">
          <p><strong>这是什么？</strong></p>
          <p>一年一度的在公园里一起写网页的活动</p>
        </div>
        <div class="question">
          <p><strong>我需要带什么？</strong></p>
          <p>充满电的电脑，和适合在草坪上的东西</p>
        </div>
        <div class="question">
          <p><strong>什么时候发生？</strong></p>
          <p>2025年8月1日，下午4点30分</p>
        </div>
        <div class="question">
          <p><strong>具体在哪里?</strong></p>
          <p>详细地址在微信群里公布</p>
        </div>

        <div class="question">
          <p><strong>谁在举办这次活动？</strong></p>
          <p>
            <a href="https://www.instagram.com/rect_repair/"
              >[[rect**]]repair</a
            >
            & shengli
          </p>
        </div>
        <div class="question">
          <p><strong>怎么报名?</strong></p>
          <p>[[[报名方式]]</p>
        </div>
        <div class="question">
          <p><strong>我不在上海，我的城市有活动吗？</strong></p>

          <p>
            看看
            <a href="https://html.energy/events.html">html energy 活动网站</a>.
            如果你所在的城市不在, 欢迎组织自己的活动!
          </p>
        </div>

        <div class="question">
          <p><strong>What should I bring?</strong></p>
          <p>a charged computer, friends, and good energy</p>
        </div>

        <div class="question">
          <p><strong>Where exactly?</strong></p>
          <p>specific location announced in wechat group</p>
        </div>
        <div class="question">
          <p><strong>Who is running this?</strong></p>
          <p>
            <a href="https://www.instagram.com/rect_repair/"
              >[[rect**]]repair</a
            >
            & shengli
          </p>
        </div>
        <div class="question">
          <p><strong>How do I sign up?</strong></p>
          <p>[[[sign up method]]]</p>
        </div>

        <div class="question">
          <p>
            <strong>I'm not in Shanghai, is there an event in my city?</strong>
          </p>
          <p>
            check out the
            <a href="https://html.energy/events.html">html energy events page</a
            >. If your city isn't listed, feel free to organize your own!
          </p>
        </div>
      </div>

      <div class="right-side">
        <div class="flowers">
          <pre></pre>
        </div>

        <!-- sign up section -->
        <div
          style="
            display: flex;
            flex-direction: column;
            /* background: white; */
          "
        >
          <h4 style="margin: 0 0 10px 0">Join the park:</h4>
          <form
            id="rsvp-form"
            style="display: flex; flex-direction: row; gap: 10px"
          >
            <input
              type="email"
              id="emailInput"
              placeholder="电子邮箱"
              required
            />
            <input type="text" id="nameInput" placeholder="名字" required />
            <div style="display: flex; align-items: center; gap: 10px">
              <label
                id="colorInputLabel"
                for="colorInput"
                style="color: #000000"
                >颜色:</label
              >
              <input type="color" id="colorInput" value="#000000" />
            </div>
            <select id="rsvpStatus" required>
              <option value="">咋说？</option>
              <option value="Going">确定会来</option>
              <option value="Maybe">可能来</option>
              <option value="Can't come">不能来</option>
            </select>
            <button type="submit" style="cursor: pointer">提交</button>
          </form>
        </div>

        <!-- picnic grid -->
        <div class="picnic-grid">
          <div class="box" id="div1">中山公园 Zhongshan Park</div>
          <div class="box" id="div2"></div>
          <div class="box" id="div3"></div>
          <div class="box" id="div4"></div>
          <div class="box" id="div5"></div>
          <div class="box" id="div6"></div>
          <div class="box" id="div7">
            <p class="boxtext">August 1, 2025 16:30-19:00 (tentative)</p>
          </div>
          <div class="box" id="div8"></div>
          <div class="box" id="div9"></div>
          <div class="box" id="div10"></div>
          <div class="box" id="div11"></div>
          <div class="box" id="div12"></div>
          <div class="box" id="div13"></div>
          <div class="box" id="div14"></div>
          <div class="box" id="div15"></div>
          <div class="box" id="div16"></div>
          <div class="box" id="div17"></div>
          <div class="box" id="div18"></div>
          <div class="box" id="div19"></div>
          <div class="box" id="div20"></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = 'https://html-energy-sh-2025.val.run';

      // Store all RSVPs data
      let allRSVPs = [];

      // Fetch existing RSVPs from API
      async function fetchRSVPs() {
        try {
          const response = await fetch(`${API_BASE_URL}/rsvps`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          allRSVPs = await response.json();
          console.log('Fetched RSVPs:', allRSVPs);
          populateGridFromAPI();
        } catch (error) {
          console.error('Failed to fetch RSVPs:', error);
          // Fallback to existing hardcoded names if API fails
          console.log('Using fallback data');
        }
      }

      // Populate the grid with data from API
      function populateGridFromAPI() {
        // Clear existing names (except the park name and date)
        const gridDivs = document.querySelectorAll('.picnic-grid .box');
        gridDivs.forEach((div, index) => {
          const divId = `div${index + 1}`;
          // Keep the park name (div1) and date (div7)
          if (divId !== 'div1' && divId !== 'div7') {
            const textContent = div.textContent.trim();
            // If it's not the park name or date, clear it
            if (
              !textContent.includes('中山公园') &&
              !textContent.includes('August 1, 2025')
            ) {
              div.innerHTML = '';
            }
          }
        });

        // Add names from API data
        const goingRSVPs = allRSVPs.filter((rsvp) => rsvp.RSVP === 'Going');
        goingRSVPs.forEach((rsvp, index) => {
          addNameToGridFromAPI(rsvp.Name, rsvp.Color || '#000000');
        });

        // Update flowers count
        updateFlowers();
      }

      // Add name to grid from API data
      function addNameToGridFromAPI(name, color) {
        const gridDivs = document.querySelectorAll('.picnic-grid .box');

        // Find empty divs (excluding park name and date)
        const emptyDivs = Array.from(gridDivs).filter((div, index) => {
          const divId = `div${index + 1}`;
          const textContent = div.textContent.trim();
          return textContent === '' && divId !== 'div1' && divId !== 'div7';
        });

        if (emptyDivs.length === 0) {
          console.log('No empty divs available for:', name);
          return;
        }

        // Pick a random empty div
        const randomIndex = Math.floor(Math.random() * emptyDivs.length);
        const selectedDiv = emptyDivs[randomIndex];

        // Add the name to the selected div with color
        selectedDiv.innerHTML = `<p class="boxtext">${name}</p>`;
        selectedDiv.style.backgroundColor = color + '10'; // Add transparency
      }

      // Handle form submission
      async function handleRSVPSubmission(event) {
        event.preventDefault();

        const email = document.getElementById('emailInput').value.trim();
        const name = document.getElementById('nameInput').value.trim();
        const color = document.getElementById('colorInput').value;
        const rsvpStatus = document.getElementById('rsvpStatus').value;

        if (!email || !name || !rsvpStatus) {
          alert('Please fill in all required fields');
          return;
        }

        // Prepare data for API
        const rsvpData = {
          Email: email,
          Name: name,
          Color: color,
          RSVP: rsvpStatus,
        };

        try {
          // Submit to API
          const response = await fetch(`${API_BASE_URL}/rsvps`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(rsvpData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || `HTTP error! status: ${response.status}`
            );
          }

          const createdRSVP = await response.json();
          console.log('RSVP created:', createdRSVP);

          // Add to local data
          allRSVPs.push(rsvpData);

          // Add to grid if status is "Going"
          if (rsvpStatus === 'Going') {
            addNameToGridFromAPI(name, color);
            updateFlowers();
            alert(`${name} 进入了公园!`);
          } else {
            alert(`${name} RSVP submitted as ${rsvpStatus}!`);
          }

          // Clear form
          document.getElementById('rsvp-form').reset();
          document.getElementById('colorInput').value = '#000000';
        } catch (error) {
          console.error('Failed to submit RSVP:', error);
          alert('Failed to submit RSVP. Please try again.');
        }
      }

      // Legacy function for backward compatibility
      function addNameToGrid() {
        // This function is kept for backward compatibility but now uses the form
        const nameInput = document.getElementById('nameInput');
        const name = nameInput.value.trim();

        if (name === '') {
          alert('无名氏？');
          return;
        }

        // Direct add to grid (fallback behavior)
        const gridDivs = document.querySelectorAll('.picnic-grid .box');
        const emptyDivs = Array.from(gridDivs).filter((div, index) => {
          const divId = `div${index + 1}`;
          const textContent = div.textContent.trim();
          return textContent === '' && divId !== 'div1' && divId !== 'div7';
        });

        if (emptyDivs.length === 0) {
          alert('来晚了，但也许你可以直接当天过来');
          return;
        }

        const randomIndex = Math.floor(Math.random() * emptyDivs.length);
        const selectedDiv = emptyDivs[randomIndex];
        selectedDiv.innerHTML = `<p class="boxtext">${name}</p>`;
        nameInput.value = '';
        updateFlowers();
        alert(`${name} 进入了公园!`);
      }

      function updateFlowers() {
        // Count how many people are in the grid
        const gridDivs = document.querySelectorAll('.picnic-grid .box');
        const peopleCount =
          Array.from(gridDivs).filter((div, index) => {
            const divId = `div${index + 1}`;
            const textContent = div.textContent.trim();
            return (
              textContent !== '' &&
              divId !== 'div1' &&
              divId !== 'div7' &&
              !textContent.includes('中山公园') &&
              !textContent.includes('August 1, 2025')
            );
          }).length + 2;

        // Get the flowers element
        const flowersElement = document.querySelector('.flowers pre');

        // Create ASCII flowers based on the count
        let flowers = '';
        const flowerLines = [
          'wWWWw',
          'vVVVv',
          '(___)',
          ' ~Y~ ',
          ' \|/ ',
          '\\|//',
        ];

        // Create horizontal layout
        for (let lineIndex = 0; lineIndex < flowerLines.length; lineIndex++) {
          let line = '';
          for (let i = 0; i < peopleCount; i++) {
            line += flowerLines[lineIndex] + '   ';
          }
          flowers += line + '\n';
        }

        // Update the flowers display
        flowersElement.textContent = flowers;
      }

      function updateColorInputLabel() {
        const colorInput = document.getElementById('colorInput');
        const colorInputLabel = document.getElementById('colorInputLabel');
        colorInputLabel.style.color = colorInput.value;
      }

      // Initialize on page load
      window.addEventListener('load', async () => {
        await fetchRSVPs();

        // Add form event listener
        const rsvpForm = document.getElementById('rsvp-form');
        rsvpForm.addEventListener('submit', handleRSVPSubmission);

        // Add color input event listener
        const colorInput = document.getElementById('colorInput');
        colorInput.addEventListener('input', updateColorInputLabel);
      });
    </script>
  </body>
</html>
